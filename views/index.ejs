<!doctype html>

<html lang="de" ng-app="led">
	<head>
		<title>led</title>

		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<style>
		#colorPicker {
			display: block;
			width: 100vw;
			height: 100vh;
		}
		</style>
	</head>
	<body>
		<div ng-view></div>

		<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.13/angular.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.13/angular-route.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.13/angular-touch.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
		<script>
		angular.module('led', [
			'home'
		  , 'color'
		  , 'ng'
		  , 'ngRoute'
		])

		.config(function($routeProvider, $locationProvider) {
			$routeProvider.otherwise({
				redirectTo: '/'
			});

			$locationProvider.html5Mode(false);
			$locationProvider.hashPrefix('!');
		});
		</script>
		<script>
		angular.module('home', ['ng', 'ngRoute'])

		.config(function($routeProvider) {
			$routeProvider.when('/', {
				templateUrl: 'home.tpl.html'
			});
		});
		</script>
		<script id="home.tpl.html" type="text/ng-template">
		<ul class="nav nav-pills nav-stacked">
			<li><a href="#!/color">Farbe wählen</a></li>
		</ul>
		</script>
		<script>
		angular.module('color', ['ng', 'ngRoute', 'ngTouch'])

		.config(function($routeProvider) {
			$routeProvider.when('/color', {
				templateUrl: 'color.tpl.html',
				controller: 'colorCtrl'
			});
		})

		.controller('colorCtrl', function($scope, $http, $swipe, $timeout, $window) {
			var height = $window.innerHeight
			  , width = $window.innerWidth
			  , colorTimeout;

			$scope.color = '#cc0000';
			$scope.updateColor = function(event) {
				var rgb = hslToRgb(event.offsetX/width, 1, event.offsetY/height);
				$timeout(function() {
					$scope.color = '#' + rgb.map(function(c) { return ('00' + c.toString(16)).slice(-2); }).join('');
				});
				if (colorTimeout) { $timeout.cancel(colorTimeout); }
				colorTimeout = $timeout(function() {
					$http.get('/api/color/' + $scope.color.substring(1));
				}, 0.3 * 1000);
			};

			$swipe.bind(angular.element(document.getElementById('colorPicker')), {
				'move': function(coords) {
					$scope.updateColor({
						offsetX: coords.x,
						offsetY: coords.y
					});
				}
			});

			function hslToRgb(h, s, l){
			    var r, g, b;

			    if(s == 0){
			        r = g = b = l; // achromatic
			    } else {
			        function hue2rgb(p, q, t){
			            if(t < 0) t += 1;
			            if(t > 1) t -= 1;
			            if(t < 1/6) return p + (q - p) * 6 * t;
			            if(t < 1/2) return q;
			            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
			            return p;
			        }

			        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
			        var p = 2 * l - q;
			        r = hue2rgb(p, q, h + 1/3);
			        g = hue2rgb(p, q, h);
			        b = hue2rgb(p, q, h - 1/3);
			    }
			    return [r, g, b].map(function(c) { return Math.round(c * 255); });
			}
		});
		</script>
		<script id="color.tpl.html" type="text/ng-template">
		<div id="colorPicker" ng-style="{'background-color': color}" ng-click="updateColor($event)"></div>
		</script>
	</body>
</html>