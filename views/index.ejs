<!doctype html>

<html lang="de" ng-app="led">
	<head>
		<title>led</title>

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

		<link rel="stylesheet" href="http://code.ionicframework.com/1.0.0-beta.8/css/ionic.min.css">
		<style>
		#colorPicker {
			display: block;
			width: 100vw;
			height: 100vh;
		}
		</style>
	</head>
	<body>
		<ion-nav-view animation="slide-left-right"></ion-nav-view>

		<script src="http://code.ionicframework.com/1.0.0-beta.8/js/ionic.bundle.min.js"></script>
		<script>
		angular.module('led', [
			'home'
		  , 'color'
		  , 'ionic'
		])

		.config(function($stateProvider, $urlRouterProvider) {
			$urlRouterProvider.otherwise('/');
		});
		</script>
		<script>
		angular.module('home', ['ionic'])

		.config(function($stateProvider) {
			$stateProvider.state('home', {
				url: '/',
				templateUrl: 'home.tpl.html'
			});
		});
		</script>
		<script id="home.tpl.html" type="text/ng-template">
		<ion-view>
			<ion-content>
				<ul class="list">
					<li class="item"><a ui-sref="color">Farbe wählen</a></li>
				</ul>
			</ion-content>
		</ion-view>
		</script>
		<script>
		angular.module('color', ['ionic'])

		.config(function($stateProvider) {
			$stateProvider.state('color', {
				url: '/color',
				templateUrl: 'color.tpl.html',
				controller: 'colorCtrl'
			});
		})

		.controller('colorCtrl', function($scope, $http, $ionicGesture, $timeout, $window, $log) {
			var height = $window.innerHeight
			  , width = $window.innerWidth
			  , colorTimeout;

			$scope.color = '#cc0000';
			$scope.updateColor = function(event) {
				var rgb = hslToRgb(event.offsetX/width, 1, event.offsetY/height);
				$timeout(function() {
					$scope.color = '#' + rgb.map(function(c) { return ('00' + c.toString(16)).slice(-2); }).join('');
				});
				if (colorTimeout) { $timeout.cancel(colorTimeout); }
				colorTimeout = $timeout(function() {
					$http.get('/api/color/' + $scope.color.substring(1));
				}, 0.3 * 1000);
			};

			$ionicGesture.on('drag', function(event) {
				$scope.updateColor({
					offsetX: event.gesture.center.pageX,
					offsetY: event.gesture.center.pageY
				});
			}, angular.element(document.getElementById('colorPicker')));

			function hslToRgb(h, s, l){
			    var r, g, b;

			    if(s == 0){
			        r = g = b = l; // achromatic
			    } else {
			        function hue2rgb(p, q, t){
			            if(t < 0) t += 1;
			            if(t > 1) t -= 1;
			            if(t < 1/6) return p + (q - p) * 6 * t;
			            if(t < 1/2) return q;
			            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
			            return p;
			        }

			        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
			        var p = 2 * l - q;
			        r = hue2rgb(p, q, h + 1/3);
			        g = hue2rgb(p, q, h);
			        b = hue2rgb(p, q, h - 1/3);
			    }
			    return [r, g, b].map(function(c) { return Math.round(c * 255); });
			}
		});
		</script>
		<script id="color.tpl.html" type="text/ng-template">
		<ion-view>
			<ion-content id="colorPicker" ng-style="{'background-color': color}" ng-click="updateColor($event)">
			</ion-content>
		</ion-view>
		</script>
	</body>
</html>